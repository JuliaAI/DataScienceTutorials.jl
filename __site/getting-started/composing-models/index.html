<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
   <!-- Syntax highlighting via Prism, note: restricted langs -->
<link rel="stylesheet" href="/libs/highlight/github.min.css">
 
  <link rel="stylesheet" href="/css/landing.css">
  <link rel="stylesheet" href="/css/franklin.css">
  <link rel="stylesheet" href="/css/pure.css">
  <link rel="stylesheet" href="/css/side-menu.css">
  <link rel="stylesheet" href="/css/nav.css">
  <link rel="stylesheet" href="/css/extra.css">
  <!-- <link rel="icon" href="/assets/infra/favicon.gif"> -->
   <title>Composing models</title> 
  <!-- LUNR -->
  <script src="/libs/lunr/lunr.min.js"></script>
  <script src="/libs/lunr/lunr_index.js"></script>
  <script src="/libs/lunr/lunrclient.min.js"></script>
</head>

<body>
  <div id="layout">
    <!-- Menu toggle / hamburger icon -->
    <a href="#menu" id="menuLink" class="menu-link"><span></span></a>
    <div id="menu" style="display: none;">
      <div class="pure-menu">
        <a href="/" id="menu-logo-link">
          <div class="menu-logo">
            <!-- <img id="menu-logo" alt="MLJ Logo" src="/assets/infra/MLJLogo2.svg" /> -->
            <p><strong>Data Science Tutorials</strong></p>
          </div>
        </a>
        <form id="lunrSearchForm" name="lunrSearchForm">
          <input class="search-input" name="q" placeholder="Search in tutorials..." type="text">
          <input type="submit" value="Search" formaction="/search/index.html" style="display:none">
        </form>
        <!-- LIST OF MENU ITEMS -->
        <ul class="pure-menu-list">
          <li class="pure-menu-item pure-menu-top-item "><a
   	      href="https://github.com/JuliaAI/DataScienceTutorials.jl"
              class="pure-menu-link"><strong>Contribute</strong></a></li>

          <!-- DATA BASICS -->
          <div class="dropdown">
            <li class="pure-menu-sublist-title"><strong>Data Basics</strong></li>
          </div>
          <div class="collapse dropdown-content">
            <ul class="pure-menu-sublist">
              <li class="pure-menu-item "><a
                  href="/data/loading/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Loading
                  data</a></li>
              <li class="pure-menu-item "><a
                  href="/data/dataframe/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Data
                  Frames</a></li>
              <li class="pure-menu-item "><a
                  href="/data/categorical/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span>
                  Categorical Arrays</a></li>
              <li class="pure-menu-item "><a
                  href="/data/scitype/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Scientific
                  Type</a></li>
              <li class="pure-menu-item "><a
                  href="/data/processing/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Data
                  processing</a></li>
            </ul>
          </div>

          <!-- GETTING STARTED WITH MLJ -->
          <div class="dropdown">
            <li class="pure-menu-sublist-title"><strong>Getting Started</strong></li>
          </div>
          <div class="collapse dropdown-content">
            <ul class="pure-menu-sublist">
              <li
                class="pure-menu-item ">
                <a href="/getting-started/choosing-a-model/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Choosing a model</a>
              </li>
              <li class="pure-menu-item ">
                <a href="/getting-started/fit-and-predict/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Fit, predict, transform</a>
              </li>
              <li class="pure-menu-item "><a
                  href="/getting-started/model-tuning/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Model tuning</a></li>
              <li class="pure-menu-item "><a
                  href="/getting-started/ensembles/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span>
                  Ensembles</a></li>
              <li class="pure-menu-item "><a
                  href="/getting-started/ensembles-2/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Ensembles 2</a></li>
              <li
                class="pure-menu-item ">
                <a href="/getting-started/composing-models/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Composing models</a>
              </li>
              <li class="pure-menu-item "><a
                  href="/getting-started/stacking/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span>
                  Stacking</a></li>
            </ul>
          </div>
          <!-- INTRO TO STATS LEARNING -->
          <div class="dropdown">
            <li class="pure-menu-sublist-title"><strong>Intro to Stats Learning</strong></li>
          </div>
          <div class="collapse dropdown-content">
            <ul class="pure-menu-sublist" id=isl>
              <li class="pure-menu-item "><a href="/isl/lab-2/"
                  class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Lab 2</a></li>
              <li class="pure-menu-item "><a href="/isl/lab-3/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Lab 3</a></li>
              <li class="pure-menu-item "><a href="/isl/lab-4/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Lab 4</a></li>
              <li class="pure-menu-item "><a href="/isl/lab-5/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Lab 5</a></li>
              <li class="pure-menu-item "><a href="/isl/lab-6b/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Lab 6b</a></li>
              <li class="pure-menu-item "><a href="/isl/lab-8/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Lab 8</a></li>
              <li class="pure-menu-item "><a href="/isl/lab-9/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Lab 9</a></li>
              <li class="pure-menu-item "><a href="/isl/lab-10/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Lab 10</a></li>
            </ul>
          </div>
          <!-- End to End -->
          <div class="dropdown">
            <li class="pure-menu-sublist-title"><strong>End to End</strong></li>
          </div>
          <div class="dropdown-content collapse">
            <ul class="pure-menu-sublist" >
              <li class="pure-menu-item "><a
                  href="/end-to-end/telco/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span>Telco
                  Churn</a></li>
              <li class="pure-menu-item "><a
                  href="/end-to-end/AMES/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> AMES</a>
              </li>
              <li class="pure-menu-item "><a href="/end-to-end/wine/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Wine</a></li>
              <li class="pure-menu-item "><a
                  href="/end-to-end/crabs-xgb/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span>
                  Crabs (XGB)</a></li>
              <li class="pure-menu-item "><a href="/end-to-end/horse/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Horse</a></li>
              <li class="pure-menu-item "><a href="/end-to-end/HouseKingCounty/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> King County Houses</a></li>
              <li class="pure-menu-item "><a href="/end-to-end/airfoil" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Airfoil </a></li>
              <li class="pure-menu-item "><a href="/end-to-end/boston-lgbm" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Boston (lgbm) </a></li>
              <li class="pure-menu-item "><a href="/end-to-end/glm/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Using GLM.jl </a></li>
              <li class="pure-menu-item "><a href="/end-to-end/powergen/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Power Generation </a></li>
              <li class="pure-menu-item "><a href="/end-to-end/boston-flux" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Boston (Flux) </a></li>
              <li class="pure-menu-item "><a href="/end-to-end/breastcancer" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Breast Cancer</a></li>
              <li class="pure-menu-item "><a href="/end-to-end/creditfraud" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Credit Fraud</a></li>
            </ul>
          </div>
          <!-- ADVANCED EXAMPLES -->
          <div class="dropdown">
            <li class="pure-menu-sublist-title"><strong>Advanced Examples</strong></li>
          </div>
          <div class="dropdown-content collapse">
            <ul class="pure-menu-sublist" id=adv>
              <li class="pure-menu-item "><a href="/advanced/ensembles-3/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Ensembles (3)</a></li>
            </ul>
          </div>
      </div>
      </ul>
      <!-- END OF LIST OF MENU ITEMS -->
    </div>
  </div>
  <div id="nav" class="navigation">
    <div class="nav-container">
      <div class="brand">
        <a href="/">DataScienceTutorials.jl</a>
      </div>
      <nav>
        <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
        <ul class="nav-list">
        <!-- horizontal navigation bar gets injected -->
        </ul>
      </nav>
    </div>
  </div>
  <div id="main"> <!-- Closed in foot -->
    

    <!-- Content appended here -->
<div class="franklin-content"><h1 id="composing_models"><a href="#composing_models" class="header-anchor">Composing models</a></h1>
<em>To ensure code in this tutorial runs as shown, download the tutorial <a href="https://raw.githubusercontent.com/juliaai/DataScienceTutorials.jl/gh-pages/__generated/getting-started/composing-models.tar.gz">project folder</a> and follow <a href="/#learning_by_doing">these instructions</a>.</em></p>
<p><em>If you have questions or suggestions about this tutorial, please open an issue <a href="https://github.com/JuliaAI/DataScienceTutorials.jl/issues/new">here</a>.</em></p>
<p><div class="franklin-toc"><ol><li><a href="#generating_dummy_data">Generating dummy data</a></li><li><a href="#wrapping_a_supervised_model_in_learned_target_transformations">Wrapping a supervised model in learned target transformations</a></li><li><a href="#the_final_pipeline">The final pipeline</a></li></ol></div>
<p>A tutorial showing how to wrap a supervised model in input feature preprocessing &#40;create a pipeline model&#41; and transforamtions of the target.</p>
<div class="dropdown"><h2 id="generating_dummy_data"><a href="#generating_dummy_data" class="header-anchor">Generating dummy data</a></h2></div>
<div class="dropdown-content"><p>Let&#39;s start by generating some dummy data with both numerical values and categorical values:</p>
<pre><code class="language-julia">using MLJ
import StableRNGs.StableRNG


RidgeRegressor &#61; @load RidgeRegressor pkg&#61;MLJLinearModels</code></pre><pre><code class="plaintext code-output">import MLJLinearModels ✔
MLJLinearModels.RidgeRegressor</code></pre>
<p>Here&#39;s a table of input features:</p>
<pre><code class="language-julia">X &#61; &#40;age    &#61; &#91;23, 45, 34, 25, 67&#93;,
     gender &#61; categorical&#40;&#91;&#39;m&#39;, &#39;m&#39;, &#39;f&#39;, &#39;m&#39;, &#39;f&#39;&#93;&#41;&#41;</code></pre><pre><code class="plaintext code-output">(age = [23, 45, 34, 25, 67],
 gender = CategoricalArrays.CategoricalValue{Char, UInt32}['m', 'm', 'f', 'm', 'f'],)</code></pre>
<p>And a vector target &#40;height in mm&#41;:</p>
<pre><code class="language-julia">y &#61; Float64&#91;1780, 1940, 1650, 1730, 1680&#93;;</code></pre>
<p>Note that the scientific type of <code>age</code> is <code>Count</code> here:</p>
<pre><code class="language-julia">schema&#40;X&#41;</code></pre><pre><code class="plaintext code-output">┌────────┬───────────────┬────────────────────────────────┐
│ names  │ scitypes      │ types                          │
├────────┼───────────────┼────────────────────────────────┤
│ age    │ Count         │ Int64                          │
│ gender │ Multiclass{2} │ CategoricalValue{Char, UInt32} │
└────────┴───────────────┴────────────────────────────────┘
</code></pre>
<p>We will want to coerce that to <code>Continuous</code> so that it can be given to a regressor that expects such values.</p>
<p>A typical workflow for such data is to one-hot-encode the categorical data and then apply some regression model on the data.</p>
<p>Let&#39;s say that we want to apply the following steps:</p>
<ol>
<li><p>One-hot encode the categorical features in <code>X</code></p>
</li>
<li><p>Apply a learned Box-Cox transformation to the target <code>y</code></p>
</li>
<li><p>Train a ridge regression model on the one-hot encoded data and the transformed target.</p>
</li>
<li><p>Return target prediction on the original scale</p>
</li>
</ol>
<p>‎</p>
<p>‎</p></div>
<div class="dropdown"><h2 id="wrapping_a_supervised_model_in_learned_target_transformations"><a href="#wrapping_a_supervised_model_in_learned_target_transformations" class="header-anchor">Wrapping a supervised model in learned target transformations</a></h2></div>
<div class="dropdown-content"><p>First, we wrap our supervised model in the target transformation we want:</p>
<pre><code class="language-julia">transformed_target_model &#61; TransformedTargetModel&#40;
    RidgeRegressor&#40;&#41;;
    transformer&#61;UnivariateBoxCoxTransformer&#40;&#41;,
&#41;</code></pre><pre><code class="plaintext code-output">TransformedTargetModelDeterministic(
  model = RidgeRegressor(
        lambda = 1.0, 
        fit_intercept = true, 
        penalize_intercept = false, 
        scale_penalty_with_samples = true, 
        solver = nothing), 
  transformer = UnivariateBoxCoxTransformer(
        n = 171, 
        shift = false), 
  inverse = nothing, 
  cache = true)</code></pre>
<p>Such a model internally transforms the target by applying the Box-Cox transformation &#40;that one that makes the data look the most Gaussian&#41; before using it to train the ridge regresssor, but it returns target predictions on the original, untransformed scale. Here&#39;s a demonstration &#40;with contiuous data&#41;:</p>
<pre><code class="language-julia">rng &#61; StableRNG&#40;123&#41;
Xcont &#61; &#40;x1 &#61; rand&#40;rng, 5&#41;, x2 &#61; rand&#40;5&#41;&#41;
mach &#61; machine&#40;transformed_target_model, Xcont, y&#41; |&gt; fit&#33;
yhat &#61; predict&#40;mach, Xcont&#41;</code></pre><pre><code class="plaintext code-output">5-element Vector{Float64}:
 1754.106294766073
 1753.1464375235225
 1748.7783411513058
 1750.6584448549415
 1753.3010865739004</code></pre>
<p>In case you need convincing, removing the target transformation indeed gives a different outcome:</p>
<pre><code class="language-julia">mach &#61; machine&#40;RidgeRegressor&#40;&#41;, Xcont, y&#41; |&gt; fit&#33;
yhat - predict&#40;mach, Xcont&#41;</code></pre><pre><code class="plaintext code-output">5-element Vector{Float64}:
 -4.003003645669651
 -4.088944024470493
 -4.062105213557061
 -3.7051768116848507
 -4.150165434873998</code></pre>
<p>‎</p></div>
<div class="dropdown"><h2 id="the_final_pipeline"><a href="#the_final_pipeline" class="header-anchor">The final pipeline</a></h2></div>
<div class="dropdown-content"><p>Next we insert our target-transformed model into a pipeline, to create a new model which includes the input data pre-processing we want:</p>
<pre><code class="language-julia">pipe &#61; &#40;X -&gt; coerce&#40;X, :age&#61;&gt;Continuous&#41;&#41; |&gt; OneHotEncoder&#40;&#41; |&gt; transformed_target_model</code></pre><pre><code class="plaintext code-output">DeterministicPipeline(
  f = var"#1#2"(), 
  one_hot_encoder = OneHotEncoder(
        features = Symbol[], 
        drop_last = false, 
        ordered_factor = true, 
        ignore = false), 
  transformed_target_model_deterministic = TransformedTargetModelDeterministic(
        model = RidgeRegressor(lambda = 1.0, …), 
        transformer = UnivariateBoxCoxTransformer(n = 171, …), 
        inverse = nothing, 
        cache = true), 
  cache = true)</code></pre>
<p>The first element in the pipelines is just an ordinary function to coerce the <code>:age</code> variable to <code>Continuous</code> &#40;needed because <code>RidgeRegressor</code> expects <code>Continuous</code> input&#41;.</p>
<p>Hyperparameters of this pipeline can be accessed &#40;and set&#41; using dot syntax:</p>
<pre><code class="language-julia">pipe.transformed_target_model_deterministic.model.lambda &#61; 10.0
pipe.one_hot_encoder.drop_last &#61; true;</code></pre>
<p>Evaluation for a pipe can be done with the <code>evaluate&#33;</code> method.</p>
<pre><code class="language-julia">evaluate&#40;pipe, X, y, resampling&#61;CV&#40;nfolds&#61;3&#41;, measure&#61;l1&#41;</code></pre><pre><code class="plaintext code-output">PerformanceEvaluation object with these fields:
  model, measure, operation, measurement, per_fold,
  per_observation, fitted_params_per_fold,
  report_per_fold, train_test_rows, resampling, repeats
Extract:
┌──────────┬───────────┬─────────────┬─────────┬───────────────────────┐
│ measure  │ operation │ measurement │ 1.96*SE │ per_fold              │
├──────────┼───────────┼─────────────┼─────────┼───────────────────────┤
│ LPLoss(  │ predict   │ 187.0       │ 129.0   │ [168.0, 141.0, 314.0] │
│   p = 1) │           │             │         │                       │
└──────────┴───────────┴─────────────┴─────────┴───────────────────────┘
</code></pre>
<p>‎</p>
<p>‎</p></div>

<div class="bottom-nav-container">
  <a id="prev-tutorial" style="text-decoration: none"><Button class="bottom-nav">
        <div>← Previous Tutorial</div>
        <div id="prev-label" class="button-label"> Home</div>
    </Button></a>
  <a id="next-tutorial" style="text-decoration: none"><Button class="bottom-nav">
        <div>Next Tutorial →</div>
        <div id="next-label" class="button-label">Home</div> 
    </Button></a>
</div>
<div class="page-foot">
  <div class="copyright">
    &copy; Thibaut Lienart, Anthony Blaom, Sebastian Vollmer and collaborators. Last modified: June 16, 2024. Website built with <a
      href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a>.
  </div>
</div></div><!-- CONTENT ENDS HERE -->
</div> <!-- end of id=main -->
</div> <!-- end of id=layout -->
<!-- for collapse functionality -->
<script src="/libs/collapse/collapse.js"></script>
<script src="/libs/pure/ui.min.js"></script>
<!-- head and footer-nav -->
<script src="/libs/nav/head.js"  type="module"></script>
<!-- landing page -->
<script src="/libs/landing/landing.js"></script>
<!-- navigation bar -->
<script src="/libs/nav/nav.js"></script>
<!-- responsive navigation bar -->
<script src="/libs/nav/responsive.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>


</body>

</html>