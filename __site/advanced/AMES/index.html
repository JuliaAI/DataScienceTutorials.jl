<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
   <!-- Syntax highlighting via Prism, note: restricted langs -->
<link rel="stylesheet" href="/libs/highlight/github.min.css">
 
  <link rel="stylesheet" href="/css/landing.css">
  <link rel="stylesheet" href="/css/franklin.css">
  <link rel="stylesheet" href="/css/pure.css">
  <link rel="stylesheet" href="/css/side-menu.css">
  <link rel="stylesheet" href="/css/nav.css">
  <link rel="stylesheet" href="/css/extra.css">
  <!-- <link rel="icon" href="/assets/infra/favicon.gif"> -->
   <title>AMES</title> 
  <!-- LUNR -->
  <script src="/libs/lunr/lunr.min.js"></script>
  <script src="/libs/lunr/lunr_index.js"></script>
  <script src="/libs/lunr/lunrclient.min.js"></script>
</head>

<body>
  <div id="layout">
    <!-- Menu toggle / hamburger icon -->
    <a href="#menu" id="menuLink" class="menu-link"><span></span></a>
    <div id="menu" style="display: none;">
      <div class="pure-menu">
        <a href="/" id="menu-logo-link">
          <div class="menu-logo">
            <!-- <img id="menu-logo" alt="MLJ Logo" src="/assets/infra/MLJLogo2.svg" /> -->
            <p><strong>Data Science Tutorials</strong></p>
          </div>
        </a>
        <form id="lunrSearchForm" name="lunrSearchForm">
          <input class="search-input" name="q" placeholder="Search in tutorials..." type="text">
          <input type="submit" value="Search" formaction="/search/index.html" style="display:none">
        </form>
        <!-- LIST OF MENU ITEMS -->
        <ul class="pure-menu-list">
          <li class="pure-menu-item pure-menu-top-item "><a
   	      href="https://github.com/JuliaAI/DataScienceTutorials.jl"
              class="pure-menu-link"><strong>Contribute</strong></a></li>

          <!-- DATA BASICS -->
          <div class="dropdown">
            <li class="pure-menu-sublist-title"><strong>Data Basics</strong></li>
          </div>
          <div class="collapse dropdown-content">
            <ul class="pure-menu-sublist">
              <li class="pure-menu-item "><a
                  href="/data/loading/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Loading
                  data</a></li>
              <li class="pure-menu-item "><a
                  href="/data/dataframe/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Data
                  Frames</a></li>
              <li class="pure-menu-item "><a
                  href="/data/categorical/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span>
                  Categorical Arrays</a></li>
              <li class="pure-menu-item "><a
                  href="/data/scitype/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Scientific
                  Type</a></li>
              <li class="pure-menu-item "><a
                  href="/data/processing/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Data
                  processing</a></li>
            </ul>
          </div>

          <!-- GETTING STARTED WITH MLJ -->
          <div class="dropdown">
            <li class="pure-menu-sublist-title"><strong>Getting Started</strong></li>
          </div>
          <div class="collapse dropdown-content">
            <ul class="pure-menu-sublist">
              <li
                class="pure-menu-item ">
                <a href="/getting-started/choosing-a-model/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Choosing a model</a>
              </li>
              <li class="pure-menu-item ">
                <a href="/getting-started/fit-and-predict/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Fit, predict, transform</a>
              </li>
              <li class="pure-menu-item "><a
                  href="/getting-started/model-tuning/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Model tuning</a></li>
              <li class="pure-menu-item "><a
                  href="/getting-started/ensembles/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span>
                  Ensembles</a></li>
              <li class="pure-menu-item "><a
                  href="/getting-started/ensembles-2/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Ensembles 2</a></li>
              <li
                class="pure-menu-item ">
                <a href="/getting-started/composing-models/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Composing models</a>
              </li>
              <li class="pure-menu-item "><a
                  href="/getting-started/stacking/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span>
                  Stacking</a></li>
            </ul>
          </div>
          <!-- INTRO TO STATS LEARNING -->
          <div class="dropdown">
            <li class="pure-menu-sublist-title"><strong>Intro to Stats Learning</strong></li>
          </div>
          <div class="collapse dropdown-content">
            <ul class="pure-menu-sublist" id=isl>
              <li class="pure-menu-item "><a href="/isl/lab-2/"
                  class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Lab 2</a></li>
              <li class="pure-menu-item "><a href="/isl/lab-3/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Lab 3</a></li>
              <li class="pure-menu-item "><a href="/isl/lab-4/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Lab 4</a></li>
              <li class="pure-menu-item "><a href="/isl/lab-5/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Lab 5</a></li>
              <li class="pure-menu-item "><a href="/isl/lab-6b/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Lab 6b</a></li>
              <li class="pure-menu-item "><a href="/isl/lab-8/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Lab 8</a></li>
              <li class="pure-menu-item "><a href="/isl/lab-9/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Lab 9</a></li>
              <li class="pure-menu-item "><a href="/isl/lab-10/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Lab 10</a></li>
            </ul>
          </div>
          <!-- End to End -->
          <div class="dropdown">
            <li class="pure-menu-sublist-title"><strong>End to End</strong></li>
          </div>
          <div class="dropdown-content collapse">
            <ul class="pure-menu-sublist" >
              <li class="pure-menu-item "><a
                  href="/end-to-end/telco/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span>Telco
                  Churn</a></li>
              <li class="pure-menu-item "><a
                  href="/end-to-end/AMES/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> AMES</a>
              </li>
              <li class="pure-menu-item "><a href="/end-to-end/wine/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Wine</a></li>
              <li class="pure-menu-item "><a
                  href="/end-to-end/crabs-xgb/" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span>
                  Crabs (XGB)</a></li>
              <li class="pure-menu-item "><a href="/end-to-end/horse/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Horse</a></li>
              <li class="pure-menu-item "><a href="/end-to-end/HouseKingCounty/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> King County Houses</a></li>
              <li class="pure-menu-item "><a href="/end-to-end/airfoil" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Airfoil </a></li>
              <li class="pure-menu-item "><a href="/end-to-end/boston-lgbm" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Boston (lgbm) </a></li>
              <li class="pure-menu-item "><a href="/end-to-end/glm/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Using GLM.jl </a></li>
              <li class="pure-menu-item "><a href="/end-to-end/powergen/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Power Generation </a></li>
              <li class="pure-menu-item "><a href="/end-to-end/boston-flux" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Boston (Flux) </a></li>
              <li class="pure-menu-item "><a href="/end-to-end/breastcancer" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Breast Cancer</a></li>
              <li class="pure-menu-item "><a href="/end-to-end/creditfraud" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Credit Fraud</a></li>
            </ul>
          </div>
          <!-- ADVANCED EXAMPLES -->
          <div class="dropdown">
            <li class="pure-menu-sublist-title"><strong>Advanced Examples</strong></li>
          </div>
          <div class="dropdown-content collapse">
            <ul class="pure-menu-sublist" id=adv>
              <li class="pure-menu-item "><a href="/advanced/ensembles-3/" class="pure-menu-link"><span
                    style="padding-right:0.5rem;">•</span> Ensembles (3)</a></li>
            </ul>
          </div>
      </div>
      </ul>
      <!-- END OF LIST OF MENU ITEMS -->
    </div>
  </div>
  <div id="nav" class="navigation">
    <div class="nav-container">
      <div class="brand">
        <a href="/">DataScienceTutorials.jl</a>
      </div>
      <nav>
        <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
        <ul class="nav-list">
        <!-- horizontal navigation bar gets injected -->
        </ul>
      </nav>
    </div>
  </div>
  <div id="main"> <!-- Closed in foot -->
    

    <!-- Content appended here -->
<div class="franklin-content"><h1 id="ames"><a href="#ames" class="header-anchor">AMES</a></h1>
<em>To ensure code in this tutorial runs as shown, download the tutorial <a href="https://raw.githubusercontent.com/juliaai/DataScienceTutorials.jl/gh-pages/__generated/advanced/AMES.tar.gz">project folder</a> and follow <a href="/#learning_by_doing">these instructions</a>.</em></p>
<p><em>If you have questions or suggestions about this tutorial, please open an issue <a href="https://github.com/JuliaAI/DataScienceTutorials.jl/issues/new">here</a>.</em></p>
<p><div class="franklin-toc"><ol><li><a href="#baby_steps">Baby steps</a></li><li><a href="#dummy_model">Dummy model</a></li><li><a href="#knn-ridge_blend">KNN-Ridge blend</a><ol><li><a href="#a_learning_network">A learning network</a></li><li><a href="#exporting_the_learning_network">Exporting the learning network</a></li><li><a href="#tuning_the_blended_model">Tuning the blended model</a></li></ol></li></ol></div>
<p>Build a model for the Ames House Price data set using a simple learning network to blend their predictions of two regressors.</p>
<div class="dropdown"><h2 id="baby_steps"><a href="#baby_steps" class="header-anchor">Baby steps</a></h2></div>
<div class="dropdown-content"><p>Let&#39;s load a reduced version of the well-known Ames House Price data set &#40;containing six of the more important categorical features and six of the more important numerical features&#41;.  The dataset can be loaded directly with <code>@load_ames</code> and the reduced version via <code>@load_reduced_ames</code>.</p>
<pre><code class="language-julia">using MLJ
import DataFrames: DataFrame
import Statistics

X, y &#61; @load_reduced_ames
X &#61; DataFrame&#40;X&#41;
@show size&#40;X&#41;
first&#40;X, 3&#41;</code></pre><pre><code class="plaintext code-output">size(X) = (1456, 12)
3×12 DataFrame
 Row │ OverallQual  GrLivArea  Neighborhood  x1stFlrSF  TotalBsmtSF  BsmtFinSF1  LotArea  GarageCars  MSSubClass    GarageArea  YearRemodAdd  YearBuilt
     │ Cat…         Float64    Categorical…  Float64    Float64      Float64     Float64  Int64       Categorical…  Float64     Int64         Int64
─────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1 │ 5                816.0  Mitchel           816.0        816.0       816.0   6600.0           2  _20                816.0          2003       1982
   2 │ 8               2028.0  Timber           2028.0       1868.0      1460.0  11443.0           3  _20                880.0          2006       2005
   3 │ 7               1509.0  Gilbert           807.0        783.0         0.0   7875.0           2  _60                393.0          2003       2003</code></pre>
<pre><code class="language-julia">schema&#40;X&#41;</code></pre><pre><code class="plaintext code-output">┌──────────────┬───────────────────┬──────────────────────────────────┐
│ names        │ scitypes          │ types                            │
├──────────────┼───────────────────┼──────────────────────────────────┤
│ OverallQual  │ OrderedFactor{10} │ CategoricalValue{Int64, UInt32}  │
│ GrLivArea    │ Continuous        │ Float64                          │
│ Neighborhood │ Multiclass{25}    │ CategoricalValue{String, UInt32} │
│ x1stFlrSF    │ Continuous        │ Float64                          │
│ TotalBsmtSF  │ Continuous        │ Float64                          │
│ BsmtFinSF1   │ Continuous        │ Float64                          │
│ LotArea      │ Continuous        │ Float64                          │
│ GarageCars   │ Count             │ Int64                            │
│ MSSubClass   │ Multiclass{15}    │ CategoricalValue{String, UInt32} │
│ GarageArea   │ Continuous        │ Float64                          │
│ YearRemodAdd │ Count             │ Int64                            │
│ YearBuilt    │ Count             │ Int64                            │
└──────────────┴───────────────────┴──────────────────────────────────┘
</code></pre>
<p>The target is a continuous vector:</p>
<pre><code class="language-julia">@show y&#91;1:3&#93;
scitype&#40;y&#41;</code></pre><pre><code class="plaintext code-output">y[1:3] = [138000.0, 369900.0, 180000.0]
AbstractVector{Continuous} (alias for AbstractArray{ScientificTypesBase.Continuous, 1})</code></pre>
<p>So this is a standard regression problem with a mix of categorical and continuous input.</p>
<p>‎</p>
<p>‎</p></div>
<div class="dropdown"><h2 id="dummy_model"><a href="#dummy_model" class="header-anchor">Dummy model</a></h2></div>
<div class="dropdown-content"><p>Remember that a &quot;model&quot; in MLJ is just a container for hyperparameters; let&#39;s take a particularly simple one: constant regression.</p>
<pre><code class="language-julia">creg &#61; ConstantRegressor&#40;&#41;</code></pre><pre><code class="plaintext code-output">ConstantRegressor(
  distribution_type = Distributions.Normal)</code></pre>
<p>Wrapping the model in data creates a <em>machine</em> which will store training outcomes &#40;<em>fit-results</em>&#41;</p>
<pre><code class="language-julia">mach &#61; machine&#40;creg, X, y&#41;</code></pre><pre><code class="plaintext code-output">untrained Machine; caches model-specific representations of data
  model: ConstantRegressor(distribution_type = Distributions.Normal)
  args: 
    1:	Source @247 ⏎ ScientificTypesBase.Table{Union{AbstractVector{ScientificTypesBase.Continuous}, AbstractVector{ScientificTypesBase.Count}, AbstractVector{ScientificTypesBase.Multiclass{25}}, AbstractVector{ScientificTypesBase.Multiclass{15}}, AbstractVector{ScientificTypesBase.OrderedFactor{10}}}}
    2:	Source @022 ⏎ AbstractVector{ScientificTypesBase.Continuous}
</code></pre>
<p>You can now train the machine specifying the data it should be trained on &#40;if unspecified, all the data will be used&#41;;</p>
<pre><code class="language-julia">train, test &#61; partition&#40;collect&#40;eachindex&#40;y&#41;&#41;, 0.70, shuffle&#61;true&#41;; # 70:30 split
fit&#33;&#40;mach, rows&#61;train&#41;
ŷ &#61; predict&#40;mach, rows&#61;test&#41;;
ŷ&#91;1:3&#93;</code></pre><pre><code class="plaintext code-output">3-element Vector{Distributions.Normal{Float64}}:
 Distributions.Normal{Float64}(μ=182894.44553483807, σ=78720.53832850652)
 Distributions.Normal{Float64}(μ=182894.44553483807, σ=78720.53832850652)
 Distributions.Normal{Float64}(μ=182894.44553483807, σ=78720.53832850652)</code></pre>
<p>Observe that the output is probabilistic, each element is a univariate normal distribution &#40;with the same mean and variance as it&#39;s a constant model&#41;.</p>
<p>You can recover deterministic output by either computing the mean of predictions or using <code>predict_mean</code> directly &#40;the <code>mean</code> function can be applied to any distribution from <a href="https://github.com/JuliaStats/Distributions.jl"><code>Distributions.jl</code></a>&#41;:</p>
<pre><code class="language-julia">ŷ &#61; predict_mean&#40;mach, rows&#61;test&#41;
ŷ&#91;1:3&#93;</code></pre><pre><code class="plaintext code-output">3-element Vector{Float64}:
 182894.44553483807
 182894.44553483807
 182894.44553483807</code></pre>
<p>You can then call any loss function from <a href="https://juliaai.github.io/StatisticalMeasures.jl/dev/">StatisticalMeasures.jl</a> to assess the quality of the model by comparing the performances on the test set:</p>
<pre><code class="language-julia">rmsl&#40;ŷ, y&#91;test&#93;&#41;</code></pre><pre><code class="plaintext code-output">0.39062726483331456</code></pre>
<p>‎</p>
<p>‎</p></div>
<div class="dropdown"><h2 id="knn-ridge_blend"><a href="#knn-ridge_blend" class="header-anchor">KNN-Ridge blend</a></h2></div>
<div class="dropdown-content"><p>Let&#39;s try something a bit fancier than a constant regressor.</p>
<ul>
<li><p>one-hot-encode categorical inputs</p>
</li>
<li><p>log-transform the target</p>
</li>
<li><p>fit both a KNN regression and a Ridge regression on the data</p>
</li>
<li><p>Compute a weighted average of individual model predictions</p>
</li>
<li><p>inverse transform &#40;exponentiate&#41; the blended prediction</p>
</li>
</ul>
<p>We are going to combine all this into a single new stand-alone composite model type, which will start by building and testing a <a href="https://alan-turing-institute.github.io/MLJ.jl/dev/learning_networks/#Learning-Networks">learning network</a>.</p>
<pre><code class="language-julia">RidgeRegressor &#61; @load RidgeRegressor pkg&#61;&quot;MultivariateStats&quot;
KNNRegressor &#61; @load KNNRegressor</code></pre><pre><code class="plaintext code-output">import MLJMultivariateStatsInterface ✔
import NearestNeighborModels ✔
NearestNeighborModels.KNNRegressor</code></pre>
<div class="dropdown"><h3 id="a_learning_network"><a href="#a_learning_network" class="header-anchor">A learning network</a></h3></div>
<div class="dropdown-content"><p>Let&#39;s start by defining the source nodes of the network, which will wrap our data. Here we are including data only for testing purposes. Later when we &quot;export&quot; our functioning network, we&#39;ll remove reference to the data.</p>
<pre><code class="language-julia">Xs &#61; source&#40;X&#41;
ys &#61; source&#40;y&#41;</code></pre><pre><code class="plaintext code-output">Source @552 ⏎ `AbstractVector{ScientificTypesBase.Continuous}`</code></pre>
<p>In our first &quot;layer&quot;, there&#39;s one-hot encoder and a log transformer; these will respectively lead to new nodes <code>W</code> and <code>z</code>:</p>
<pre><code class="language-julia">hot &#61; machine&#40;OneHotEncoder&#40;&#41;, Xs&#41;

W &#61; transform&#40;hot, Xs&#41;
z &#61; log&#40;ys&#41;</code></pre><pre><code class="plaintext code-output">Node @814
  args:
    1:	Source @552
  formula:
    #99(
      Source @552)</code></pre>
<p>In the second &quot;layer&quot;, there&#39;s a KNN regressor and a ridge regressor, these lead to nodes <code>ẑ₁</code> and <code>ẑ₂</code></p>
<pre><code class="language-julia">knn   &#61; machine&#40;KNNRegressor&#40;K&#61;5&#41;, W, z&#41;
ridge &#61; machine&#40;RidgeRegressor&#40;lambda&#61;2.5&#41;, W, z&#41;

ẑ₁ &#61; predict&#40;knn, W&#41;
ẑ₂ &#61; predict&#40;ridge, W&#41;</code></pre><pre><code class="plaintext code-output">Node @744 → RidgeRegressor(…)
  args:
    1:	Node @068 → OneHotEncoder(…)
  formula:
    predict(
      machine(RidgeRegressor(lambda = 2.5, …), …), 
      transform(
        machine(OneHotEncoder(features = Symbol[], …), …), 
        Source @329))</code></pre>
<p>In the third &quot;layer&quot;, there&#39;s a weighted combination of the two regression models:</p>
<pre><code class="language-julia">ẑ &#61; 0.3ẑ₁ &#43; 0.7ẑ₂;</code></pre>
<p>And finally we need to invert the initial transformation of the target &#40;which was a log&#41;:</p>
<pre><code class="language-julia">ŷ &#61; exp&#40;ẑ&#41;;</code></pre>
<p>You&#39;ve now defined the learning network we need, which we test like this:</p>
<pre><code class="language-julia">fit&#33;&#40;ŷ, rows&#61;train&#41;;
preds &#61; ŷ&#40;rows&#61;test&#41;;
rmsl&#40;preds, y&#91;test&#93;&#41;</code></pre><pre><code class="plaintext code-output">0.12734073116816833</code></pre>
<p>While that&#39;s essentially all we need to solve our problem, we&#39;ll go one step further, exporting our learning network as a stand-alone model type we can apply to any data set, and treat like any other type. In particular, this will make tuning the &#40;nested&#41; model hyperparameters easier.</p>
<p>‎</p>
<p>‎</p></div>
<div class="dropdown"><h3 id="exporting_the_learning_network"><a href="#exporting_the_learning_network" class="header-anchor">Exporting the learning network</a></h3></div>
<div class="dropdown-content"><p>Here&#39;s the struct for our new model type. Notice it has other models as hyperparameters.</p>
<pre><code class="language-julia">mutable struct BlendedRegressor &lt;: DeterministicNetworkComposite
    knn_model
    ridge_model
    knn_weight::Float64
end</code></pre>
<p>Note the supertype <code>DeterministicNetworkComposite</code> here, which we are using because our composite model will always make deterministic predictions, and because we are exporting a learning network to make our new composite model. Refer to documentation for other options here.</p>
<p>The other step we need is to wrap our learning network in a <code>prefit</code> definition, substituting the component models we used with symbol &quot;placeholders&quot; with names corresponding to fields of our new struct. We&#39;ll also use the <code>knn_weight</code> field of our struct to set the mix, instead of hard-coding it as we did above.</p>
<pre><code class="language-julia">import MLJ.MLJBase.prefit
function prefit&#40;model::BlendedRegressor, verbosity, X, y&#41;
    Xs &#61; source&#40;X&#41;
    ys &#61; source&#40;y&#41;

    hot &#61; machine&#40;OneHotEncoder&#40;&#41;, Xs&#41;
    W &#61; transform&#40;hot, Xs&#41;

    z &#61; log&#40;ys&#41;

    knn &#61; machine&#40;:knn_model, W, z&#41;
    ridge &#61; machine&#40;:ridge_model, W, z&#41;
    ẑ &#61; model.knn_weight * predict&#40;knn, W&#41; &#43; &#40;1.0 - model.knn_weight&#41; * predict&#40;ridge, W&#41;

    ŷ &#61; exp&#40;ẑ&#41;

    &#40;predict&#61;ŷ,&#41;
end</code></pre><pre><code class="plaintext code-output">prefit (generic function with 7 methods)</code></pre>
<p>We can now instantiate and fit such a model:</p>
<pre><code class="language-julia">blended &#61; BlendedRegressor&#40;KNNRegressor&#40;K&#61;5&#41;, RidgeRegressor&#40;lambda&#61;2.5&#41;, 0.3&#41;
mach &#61; machine&#40;blended, X, y&#41;
fit&#33;&#40;mach, rows&#61;train&#41;

preds &#61; predict&#40;mach, rows&#61;test&#41;
rmsl&#40;preds, y&#91;test&#93;&#41;</code></pre><pre><code class="plaintext code-output">0.12734073116816833</code></pre>
<p>‎</p>
<p>‎</p></div>
<div class="dropdown"><h3 id="tuning_the_blended_model"><a href="#tuning_the_blended_model" class="header-anchor">Tuning the blended model</a></h3></div>
<div class="dropdown-content"><p>Before we get started, it&#39;s important to note that the hyperparameters of the model have different levels of <em>nesting</em>. This becomes explicit when trying to access elements:</p>
<pre><code class="language-julia">@show blended.knn_weight
@show blended.knn_model.K
@show blended.ridge_model.lambda</code></pre><pre><code class="plaintext code-output">blended.knn_weight = 0.3
blended.knn_model.K = 5
blended.ridge_model.lambda = 2.5
</code></pre>
<p>You can see what names to use here from the way the model instance is displayed:</p>
<pre><code class="language-julia">blended</code></pre><pre><code class="plaintext code-output">BlendedRegressor(
  knn_model = KNNRegressor(
        K = 5, 
        algorithm = :kdtree, 
        metric = Distances.Euclidean(0.0), 
        leafsize = 10, 
        reorder = true, 
        weights = NearestNeighborModels.Uniform()), 
  ridge_model = RidgeRegressor(
        lambda = 2.5, 
        bias = true), 
  knn_weight = 0.3)</code></pre>
<p>The range of values to do your hyperparameter tuning over should follow the nesting structure reflected by <code>params</code>:</p>
<pre><code class="language-julia">k_range &#61; range&#40;blended, :&#40;knn_model.K&#41;, lower&#61;2, upper&#61;100, scale&#61;:log10&#41;
l_range &#61; range&#40;blended, :&#40;ridge_model.lambda&#41;, lower&#61;1e-4, upper&#61;10, scale&#61;:log10&#41;
w_range &#61; range&#40;blended, :&#40;knn_weight&#41;, lower&#61;0.1, upper&#61;0.9&#41;

ranges &#61; &#91;k_range, l_range, w_range&#93;</code></pre><pre><code class="plaintext code-output">3-element Vector{MLJBase.NumericRange{T, MLJBase.Bounded, Symbol} where T}:
 NumericRange(2 ≤ knn_model.K ≤ 100; origin=51.0, unit=49.0; on log10 scale)
 NumericRange(0.0001 ≤ ridge_model.lambda ≤ 10; origin=5.0, unit=5.0; on log10 scale)
 NumericRange(0.1 ≤ knn_weight ≤ 0.9; origin=0.5, unit=0.4)</code></pre>
<p>Now there remains to define how the tuning should be done. Let&#39;s just specify a coarse grid tuning with cross validation and instantiate a tuned model:</p>
<pre><code class="language-julia">tuned_blended &#61; TunedModel&#40;
    blended;
    tuning&#61;Grid&#40;resolution&#61;7&#41;,
    resampling&#61;CV&#40;nfolds&#61;6&#41;,
    ranges,
    measure&#61;rmsl,
    acceleration&#61;CPUThreads&#40;&#41;,
&#41;</code></pre><pre><code class="plaintext code-output">DeterministicTunedModel(
  model = BlendedRegressor(
        knn_model = KNNRegressor(K = 5, …), 
        ridge_model = RidgeRegressor(lambda = 2.5, …), 
        knn_weight = 0.3), 
  tuning = Grid(
        goal = nothing, 
        resolution = 7, 
        shuffle = true, 
        rng = Random._GLOBAL_RNG()), 
  resampling = CV(
        nfolds = 6, 
        shuffle = false, 
        rng = Random._GLOBAL_RNG()), 
  measure = RootMeanSquaredLogError(), 
  weights = nothing, 
  class_weights = nothing, 
  operation = nothing, 
  range = MLJBase.NumericRange{T, MLJBase.Bounded, Symbol} where T[NumericRange(2 ≤ knn_model.K ≤ 100; origin=51.0, unit=49.0; on log10 scale), NumericRange(0.0001 ≤ ridge_model.lambda ≤ 10; origin=5.0, unit=5.0; on log10 scale), NumericRange(0.1 ≤ knn_weight ≤ 0.9; origin=0.5, unit=0.4)], 
  selection_heuristic = MLJTuning.NaiveSelection(nothing), 
  train_best = true, 
  repeats = 1, 
  n = nothing, 
  acceleration = ComputationalResources.CPUThreads{Int64}(1), 
  acceleration_resampling = ComputationalResources.CPU1{Nothing}(nothing), 
  check_measure = true, 
  cache = true)</code></pre>
<p>For more tuning options, see <a href="https://alan-turing-institute.github.io/MLJ.jl/dev/tuning_models/">the docs</a>.</p>
<p>Now <code>tuned_blended</code> is a &quot;self-tuning&quot; version of the original model, with all the necessary resampling occurring under the hood. You can think of wrapping a model in <code>TunedModel</code> as moving the tuned hyperparameters to <em>learned</em> parameters.</p>
<pre><code class="language-julia">mach &#61; machine&#40;tuned_blended, X, y&#41;
fit&#33;&#40;mach, rows&#61;train&#41;;</code></pre>
<p>To retrieve the best model, you can use:</p>
<pre><code class="language-julia">blended_best &#61; fitted_params&#40;mach&#41;.best_model
@show blended_best.knn_model.K
@show blended_best.ridge_model.lambda
@show blended_best.knn_weight</code></pre><pre><code class="plaintext code-output">blended_best.knn_model.K = 4
blended_best.ridge_model.lambda = 0.2154434690031884
blended_best.knn_weight = 0.1
</code></pre>
<p>you can also use <code>mach</code> to make predictions &#40;which will be done using the best model, trained on <em>all</em> the <code>train</code> data&#41;:</p>
<pre><code class="language-julia">preds &#61; predict&#40;mach, rows&#61;test&#41;
rmsl&#40;y&#91;test&#93;, preds&#41;</code></pre><pre><code class="plaintext code-output">0.12277868247506635</code></pre>
<p>‎</p></div>
<p>‎</p></div>

<div class="bottom-nav-container">
  <a id="prev-tutorial" style="text-decoration: none"><Button class="bottom-nav">
        <div>← Previous Tutorial</div>
        <div id="prev-label" class="button-label"> Home</div>
    </Button></a>
  <a id="next-tutorial" style="text-decoration: none"><Button class="bottom-nav">
        <div>Next Tutorial →</div>
        <div id="next-label" class="button-label">Home</div> 
    </Button></a>
</div>
<div class="page-foot">
  <div class="copyright">
    &copy; Thibaut Lienart, Anthony Blaom, Sebastian Vollmer and collaborators. Last modified: June 16, 2024. Website built with <a
      href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a>.
  </div>
</div></div><!-- CONTENT ENDS HERE -->
</div> <!-- end of id=main -->
</div> <!-- end of id=layout -->
<!-- for collapse functionality -->
<script src="/libs/collapse/collapse.js"></script>
<script src="/libs/pure/ui.min.js"></script>
<!-- head and footer-nav -->
<script src="/libs/nav/head.js"  type="module"></script>
<!-- landing page -->
<script src="/libs/landing/landing.js"></script>
<!-- navigation bar -->
<script src="/libs/nav/nav.js"></script>
<!-- responsive navigation bar -->
<script src="/libs/nav/responsive.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>


</body>

</html>