<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
   <!-- Syntax highlighting via Prism, note: restricted langs -->
<link rel="stylesheet" href="/libs/highlight/github.min.css">
   
  <link rel="stylesheet" href="/css/judoc.css">
  <link rel="stylesheet" href="/css/pure.css">
  <link rel="stylesheet" href="/css/side-menu.css">
  <link rel="stylesheet" href="/css/extra.css">
  <!-- <link rel="icon" href="/assets/infra/favicon.gif"> -->
   <title></title>  
</head>
<body>
  <div id="layout">
    <!-- Menu toggle / hamburger icon -->
    <a href="#menu" id="menuLink" class="menu-link"><span></span></a>
    <div id="menu">
      <div class="pure-menu">
        <a href="/" id="menu-logo-link">
          <div class="menu-logo">
            <img id="menu-logo" alt="MLJ Logo" src="/assets/infra/MLJLogo2.svg" />
            <p><strong>MLJ Tutorials</strong></p>
          </div>
        </a>
        <ul class="pure-menu-list">
          <li class="pure-menu-item pure-menu-top-item "><a href="/" class="pure-menu-link"><strong>Home</strong></a></li>

          <li class="pure-menu-sublist-title"><strong>Getting started</strong></li>
          <ul class="pure-menu-sublist">
            <li class="pure-menu-item "><a href="/pub/getting-started/choosing-a-model.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Choosing a model</a></li>
            <li class="pure-menu-item "><a href="/pub/getting-started/fit-and-predict.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Fit, predict, transform</a></li>
            <li class="pure-menu-item "><a href="/pub/getting-started/model-tuning.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Model tuning</a></li>
            <li class="pure-menu-item "><a href="/pub/getting-started/ensembles.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Ensembles</a></li>
            <li class="pure-menu-item "><a href="/pub/getting-started/ensembles-2.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Ensembles (2)</a></li>
            <li class="pure-menu-item "><a href="/pub/getting-started/composing-models.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Composing models</a></li>
            <li class="pure-menu-item "><a href="/pub/getting-started/learning-networks.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Learning networks</a></li>
            <li class="pure-menu-item "><a href="/pub/getting-started/learning-networks-2.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Learning networks (2)</a></li>
          </ul>

          <li class="pure-menu-sublist-title"><strong>Intro to Stats Learning</strong></li>
          <ul class="pure-menu-sublist" id=isl>
            <li class="pure-menu-item "><a href="/pub/isl/lab-2.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Lab 2</a></li>
            <li class="pure-menu-item "><a href="/pub/isl/lab-3.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Lab 3</a></li>
            <li class="pure-menu-item "><a href="/pub/isl/lab-4.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Lab 4</a></li>
            <li class="pure-menu-item "><a href="/pub/isl/lab-5.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Lab 5</a></li>
            <li class="pure-menu-item "><a href="/pub/isl/lab-6b.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Lab 6b</a></li>
            <li class="pure-menu-item "><a href="/pub/isl/lab-8.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Lab 8</a></li>
            <li class="pure-menu-item "><a href="/pub/isl/lab-9.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Lab 9</a></li>
            <li class="pure-menu-item "><a href="/pub/isl/lab-10.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Lab 10</a></li>
          </ul>

          <li class="pure-menu-sublist-title"><strong>End to end examples</strong></li>
          <ul class="pure-menu-sublist" id=e2e>
            <li class="pure-menu-item "><a href="/pub/end-to-end/AMES.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> AMES</a></li>
            <li class="pure-menu-item "><a href="/pub/end-to-end/wine.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Wine</a></li>
            <li class="pure-menu-item "><a href="/pub/end-to-end/crabs-xgb.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Crabs (XGB)</a></li>
            <li class="pure-menu-item "><a href="/pub/end-to-end/horse.html" class="pure-menu-link"><span style="padding-right:0.5rem;">•</span> Horse</a></li>
          </ul>
        </ul>
      </div>
    </div>
    <div id="main"> <!-- Closed in foot -->
      

<!-- Content appended here -->

<div class="jd-content">
<h1 id="horse_colic_data"><a href="/pub/end-to-end/horse.html#horse_colic_data">Horse colic data</a></h1>
<em>Download the</em> <a href="https://raw.githubusercontent.com/alan-turing-institute/MLJTutorials/gh-pages/notebooks/EX-horse.ipynb" target="_blank"><em>notebook</em></a>, <em>the</em> <a href="https://raw.githubusercontent.com/alan-turing-institute/MLJTutorials/gh-pages/scripts/EX-horse-raw.jl" target="_blank"><em>raw script</em></a>, <em>or the</em> <a href="https://raw.githubusercontent.com/alan-turing-institute/MLJTutorials/gh-pages/scripts/EX-horse.jl" target="_blank"><em>annoted script</em></a> <em>for this tutorial &#40;right-click on the link and save&#41;.</em> <div class="jd-toc"><ol><li><a href="/pub/end-to-end/horse.html#initial_data_processing">Initial data processing</a><ol><li><a href="/pub/end-to-end/horse.html#getting_the_data">Getting the data</a></li><li><a href="/pub/end-to-end/horse.html#inspecting_columns">Inspecting columns</a></li><li><a href="/pub/end-to-end/horse.html#dealing_with_missing_values">Dealing with missing values</a></li></ol></li><li><a href="/pub/end-to-end/horse.html#a_baseline_model">A baseline model</a></li><li><a href="/pub/end-to-end/horse.html#trying_another_model">Trying another model</a></li></ol></div><h2 id="initial_data_processing"><a href="/pub/end-to-end/horse.html#initial_data_processing">Initial data processing</a></h2>
<p>In this example, we consider the <a href="https://archive.ics.uci.edu/ml/datasets/Horse&#43;Colic">UCI &quot;horse colic&quot; dataset</a></p>
<p>This is a reasonably messy classification problem with missing values etc and so some work should be expected in the feature processing.</p>
<h3 id="getting_the_data"><a href="/pub/end-to-end/horse.html#getting_the_data">Getting the data</a></h3>
<p>The data is pre-split in training and testing and we will keep it as such</p>
<pre><code class="language-julia">using MLJ, StatsBase, ScientificTypes
using HTTP, CSV, DataFrames
req1 = HTTP.get("https://archive.ics.uci.edu/ml/machine-learning-databases/horse-colic/horse-colic.data")
req2 = HTTP.get("https://archive.ics.uci.edu/ml/machine-learning-databases/horse-colic/horse-colic.test")
header = ["surgery", "age", "hospital_number",
    "rectal_temperature", "pulse",
    "respiratory_rate", "temperature_extremities",
    "peripheral_pulse", "mucous_membranes",
    "capillary_refill_time", "pain",
    "peristalsis", "abdominal_distension",
    "nasogastric_tube", "nasogastric_reflux",
    "nasogastric_reflux_ph", "feces", "abdomen",
    "packed_cell_volume", "total_protein",
    "abdomcentesis_appearance", "abdomcentesis_total_protein",
    "outcome", "surgical_lesion", "lesion_1", "lesion_2", "lesion_3",
    "cp_data"]
csv_opts = (header=header, delim=' ', missingstring="?",
            ignorerepeated=true)
data_train = CSV.read(req1.body; csv_opts...)
data_test  = CSV.read(req2.body; csv_opts...)
@show size(data_train)
@show size(data_test)</code></pre><div class="code_output"><pre><code class="plaintext">size(data_train) = (300, 28)
size(data_test) = (68, 28)
</code></pre></div>
<h3 id="inspecting_columns"><a href="/pub/end-to-end/horse.html#inspecting_columns">Inspecting columns</a></h3>
<p>To simplify the analysis, we will drop the columns <code>Lesion *</code> as they would need specific re-encoding which would distract us a bit.</p>
<pre><code class="language-julia">unwanted = [:lesion_1, :lesion_2, :lesion_3]
data = vcat(data_train, data_test)
select!(data, Not(unwanted));</code></pre>
<p>Let&#39;s also keep track of the initial train-test split</p>
<pre><code class="language-julia">train = 1:nrows(data_train)
test = last(train) .+ (1:nrows(data_test));</code></pre>
<p>We know from reading the description that some of these features represent multiclass data; to facilitate the interpretation, we can use <code>autotype</code> from <code>ScientificTypes</code>. By default, <code>autotype</code> will check all columns and suggest a Finite type assuming there are relatively few distinct values in the column. More sophisticated rules can be passed, see <a href="https://alan-turing-institute.github.io/ScientificTypes.jl/dev/">ScientificTypes.jl</a>:</p>
<pre><code class="language-julia">datac = coerce(data, autotype(data));</code></pre>
<p>Let&#39;s see column by column whether it looks ok now</p>
<pre><code class="language-julia">sch = schema(datac)
for (name, scitype) in zip(sch.names, sch.scitypes)
    println(rpad("$name", 30), scitype)
end</code></pre><div class="code_output"><pre><code class="plaintext">surgery                       Union{Missing, OrderedFactor{2}}
age                           OrderedFactor{2}
hospital_number               Count
rectal_temperature            Union{Missing, Continuous}
pulse                         Union{Missing, Count}
respiratory_rate              Union{Missing, Count}
temperature_extremities       Union{Missing, OrderedFactor{4}}
peripheral_pulse              Union{Missing, OrderedFactor{4}}
mucous_membranes              Union{Missing, OrderedFactor{6}}
capillary_refill_time         Union{Missing, OrderedFactor{3}}
pain                          Union{Missing, OrderedFactor{5}}
peristalsis                   Union{Missing, OrderedFactor{4}}
abdominal_distension          Union{Missing, OrderedFactor{4}}
nasogastric_tube              Union{Missing, OrderedFactor{3}}
nasogastric_reflux            Union{Missing, OrderedFactor{3}}
nasogastric_reflux_ph         Union{Missing, OrderedFactor{24}}
feces                         Union{Missing, OrderedFactor{4}}
abdomen                       Union{Missing, OrderedFactor{5}}
packed_cell_volume            Union{Missing, Continuous}
total_protein                 Union{Missing, Continuous}
abdomcentesis_appearance      Union{Missing, OrderedFactor{3}}
abdomcentesis_total_protein   Union{Missing, Continuous}
outcome                       Union{Missing, OrderedFactor{3}}
surgical_lesion               OrderedFactor{2}
cp_data                       OrderedFactor{2}
</code></pre></div>
<p>Most columns are now treated as either Multiclass or Ordered, this corresponds to the <a href="https://archive.ics.uci.edu/ml/datasets/Horse&#43;Colic">description of the data</a>. For instance:</p>
<ul>
<li><p><code>Surgery</code> is described as <code>1&#61;yes / 2&#61;no</code></p>
</li>
<li><p><code>Age</code> is described as <code>1&#61;adult / 2&#61;young</code></p>
</li>
</ul>
<p>Inspecting the rest of the descriptions and the current scientific type, there are a few more things that can be observed:</p>
<ul>
<li><p>hospital number is still a count, this means that there are relatively many hospitals and so  that&#39;s  probably not very useful,</p>
</li>
<li><p>pulse and respiratory rate are still as count but the data description suggests that they can be considered as continuous</p>
</li>
</ul>
<pre><code class="language-julia">length(unique(datac.hospital_number))</code></pre><div class="code_output"><pre><code class="plaintext">346</code></pre></div>
<p>yeah let&#39;s drop that</p>
<pre><code class="language-julia">datac = select!(datac, Not(:hospital_number));</code></pre>
<p>let&#39;s also coerce the pulse and respiratory rate, in fact we can do that with <code>autotype</code> specifying as rule the <code>discrete_to_continuous</code>
<pre><code class="language-julia">datac = coerce(datac, autotype(datac, rules=(:discrete_to_continuous,)));</code></pre>
<h3 id="dealing_with_missing_values"><a href="/pub/end-to-end/horse.html#dealing_with_missing_values">Dealing with missing values</a></h3>
<p>There&#39;s quite a lot of missing values, in this tutorial we&#39;ll be a bit rough in how we deal with them applying the following rules of thumb:</p>
<ul>
<li><p>drop the rows where the outcome is unknown</p>
</li>
<li><p>drop columns with more than 20&#37; missing values</p>
</li>
<li><p>simple imputation of whatever&#39;s left</p>
</li>
</ul>
<pre><code class="language-julia">missing_outcome = ismissing.(datac.outcome)
idx_missing_outcome = missing_outcome |> findall</code></pre><div class="code_output"><pre><code class="plaintext">2-element Array{Int64,1}:
 133
 309</code></pre></div>
<p>Ok there&#39;s only two row which is nice, let&#39;s remove them from the train/test indices and drop the rows</p>
<pre><code class="language-julia">train = setdiff!(train |> collect, idx_missing_outcome)
test = setdiff!(test |> collect, idx_missing_outcome)
datac = datac[.!missing_outcome, :];</code></pre>
<p>Now let&#39;s look at how many missings there are per features</p>
<pre><code class="language-julia">for name in names(datac)
    col = datac[:, name]
    ratio_missing = sum(ismissing.(col)) / nrows(datac) * 100
    println(rpad(name, 30), round(ratio_missing, sigdigits=3))
end</code></pre><div class="code_output"><pre><code class="plaintext">surgery                       0.0
age                           0.0
rectal_temperature            18.9
pulse                         7.1
respiratory_rate              19.4
temperature_extremities       17.5
peripheral_pulse              22.7
mucous_membranes              13.1
capillary_refill_time         10.4
pain                          17.2
peristalsis                   13.9
abdominal_distension          17.5
nasogastric_tube              35.5
nasogastric_reflux            36.1
nasogastric_reflux_ph         81.1
feces                         34.7
abdomen                       39.1
packed_cell_volume            9.84
total_protein                 11.5
abdomcentesis_appearance      52.7
abdomcentesis_total_protein   63.9
outcome                       0.0
surgical_lesion               0.0
cp_data                       0.0
</code></pre></div>
<p>Let&#39;s drop the ones with more than 20&#37; &#40;quite a few&#33;&#41;</p>
<pre><code class="language-julia">unwanted = [:peripheral_pulse, :nasogastric_tube, :nasogastric_reflux,
        :nasogastric_reflux_ph, :feces, :abdomen, :abdomcentesis_appearance, :abdomcentesis_total_protein]
select!(datac, Not(unwanted));</code></pre>
<p>Note that we could have done this better and investigated the nature of the features for which there&#39;s a lot of missing values but don&#39;t forget that our goal is to showcase MLJ&#33;</p>
<p>Let&#39;s conclude by filling all missing values and separating the feature matrix from the  target</p>
<pre><code class="language-julia">@load FillImputer
filler = machine(FillImputer(), datac)
fit!(filler)
datac = transform(filler, datac)

y, X = unpack(datac, ==(:outcome), name->true);</code></pre>
<h2 id="a_baseline_model"><a href="/pub/end-to-end/horse.html#a_baseline_model">A baseline model</a></h2>
<p>Let&#39;s define a first sensible model and get a baseline, basic steps are:</p>
<ul>
<li><p>one-hot-encode the categoricals</p>
</li>
<li><p>feed all this into a classifier</p>
</li>
</ul>
<pre><code class="language-julia">@load OneHotEncoder
@load MultinomialClassifier pkg="MLJLinearModels"</code></pre><div class="code_output"><pre><code class="plaintext">MLJLinearModels.MultinomialClassifier(lambda = 1.0,
                                      gamma = 0.0,
                                      penalty = :l2,
                                      fit_intercept = true,
                                      penalize_intercept = false,
                                      solver = nothing,) @ 2…14</code></pre></div>
<p>Let&#39;s have convenient handles over the training data</p>
<pre><code class="language-julia">Xtrain = X[train,:]
ytrain = y[train];</code></pre>
<p>And let&#39;s define a pipeline corresponding to the operations above</p>
<pre><code class="language-julia">@pipeline SimplePipe(hot = OneHotEncoder(),
                     clf = MultinomialClassifier()) is_probabilistic=true
mach = machine(SimplePipe(), Xtrain, ytrain)
res = evaluate!(mach; resampling=Holdout(fraction_train=0.9),
                measure=cross_entropy)
round(res.measurement[1], sigdigits=3)</code></pre><div class="code_output"><pre><code class="plaintext">0.704</code></pre></div>
<p>This is the cross entropy on some held-out 10&#37; of the training set. We can also just for the sake of getting a baseline, see the misclassification on the whole training data:</p>
<pre><code class="language-julia">ŷ = predict_mode(mach, Xtrain)
mcr = misclassification_rate(ŷ, ytrain)
println(rpad("MNC mcr:", 10), round(mcr, sigdigits=3))</code></pre><div class="code_output"><pre><code class="plaintext">MNC mcr:  0.234
</code></pre></div>
<p>That&#39;s not bad at all actually. Let&#39;s tune it a bit and see if we can get a bit better than that, not much point in going crazy, we might get a few percents but not much more.</p>
<pre><code class="language-julia">model = SimplePipe()
lambdas = range(model, :(clf.lambda), lower=1e-3, upper=100, scale=:log10)
tm = TunedModel(model=SimplePipe(), ranges=lambdas, measure=cross_entropy)
mtm = machine(tm, Xtrain, ytrain)
fit!(mtm)
best_pipe = fitted_params(mtm).best_model</code></pre><div class="code_output"><pre><code class="plaintext">JuDoc.SimplePipe(hot = OneHotEncoder(features = Symbol[],
                                     drop_last = false,
                                     ordered_factor = true,),
                 clf = MLJLinearModels.MultinomialClassifier(lambda = 27.825594022071243,
                                                             gamma = 0.0,
                                                             penalty = :l2,
                                                             fit_intercept = true,
                                                             penalize_intercept = false,
                                                             solver = nothing,),) @ 1…76</code></pre></div>
<p>So it looks like it&#39;s useful to regularise a fair bit to get a lower cross entropy</p>
<pre><code class="language-julia">ŷ = predict(mtm, Xtrain)
cross_entropy(ŷ, ytrain) |> mean</code></pre><div class="code_output"><pre><code class="plaintext">0.6129047398190444</code></pre></div>
<p>Interestingly this does not improve our missclassification rate</p>
<pre><code class="language-julia">mcr = misclassification_rate(mode.(ŷ), ytrain)
println(rpad("MNC mcr:", 10), round(mcr, sigdigits=3))</code></pre><div class="code_output"><pre><code class="plaintext">MNC mcr:  0.278
</code></pre></div>
<p>We&#39;ve probably reached the limit of a simple linear model.</p>
<h2 id="trying_another_model"><a href="/pub/end-to-end/horse.html#trying_another_model">Trying another model</a></h2>
<p>There are lots of categoricals, so maybe  it&#39;s just better to use something that deals well with that like a tree-based classifier.</p>
<pre><code class="language-julia">@load XGBoostClassifier
dtc = machine(XGBoostClassifier(), Xtrain, ytrain)
fit!(dtc)
ŷ = predict(dtc, Xtrain)
cross_entropy(ŷ, ytrain) |> mean</code></pre><div class="code_output"><pre><code class="plaintext">0.8421916f0</code></pre></div>
<p>So we get a worse cross entropy but...</p>
<pre><code class="language-julia">misclassification_rate(mode.(ŷ), ytrain)</code></pre><div class="code_output"><pre><code class="plaintext">0.11371237458193979</code></pre></div>
<p>a significantly better misclassification rate.</p>
<p>We could investigate more, do more tuning etc, but the key points of this tutorial was to show how to handle data with missing values.
<div class="page-foot">
  <div class="copyright">
    &copy; Anthony Blaom, Thibaut Lienart and collaborators. Last modified: October 30, 2019. Website built with <a href="https://github.com/tlienart/JuDoc.jl">JuDoc.jl</a>.
  </div>
</div>

</div>
<!-- CONTENT ENDS HERE -->
      </div> <!-- end of id=main -->
  </div> <!-- end of id=layout -->
  <script src="/libs/pure/ui.min.js"></script>
  
  
      <script src="/libs/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>

  
</body>
</html>
